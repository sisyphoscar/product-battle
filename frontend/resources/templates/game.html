<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Battle</title>
    <style>
        .battle-wrapper {
            display: flex;
            justify-content: space-around;
        }
    </style>
</head>
<body>
    <h1>Product Battle</h1>
    <div id="product-container">
        <p>Loading...</p>
    </div>

    <script>
        const PRODUCT_Endpoint = "{{ .productEndpoint }}";
        let products = [];

        let currentWinner = null;
        let currentRound = 1;
        const battleResults = [];

        // Fetch product data from API
        async function fetchProducts() {
            const container = document.getElementById("product-container");
            try {
                const response = await fetch(PRODUCT_Endpoint + "/api/products");
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const result = await response.json();

                if (!result || result.status !== 200 || !Array.isArray(result.data) || result.data.length < 2) {
                    throw new Error("Product data format is incorrect");
                }

                products = result.data;
                currentWinner = products[0]; // default winner

                renderBattleIfNeeded();
            } catch (error) {
                console.error("Get product data error:", error);
                container.innerHTML = `<p>Unable to load products, please try again later.</p>`;
            }
        }

        // Render the battle UI if needed
        function renderBattleIfNeeded() {
            const container = document.getElementById("product-container");
            container.innerHTML = ""; // Clear previous content

            if (products.length < 2) {
                renderEndMessage(container);
                return;
            }

            renderBattle(container);
        }

        // Render the end message
        function renderEndMessage(container) {
            const endMessage = createElement("p", {}, "The battle has ended! Thank you for participating."); // Updated message
            container.appendChild(endMessage);
            console.log("Battle results:", JSON.stringify({ seasonId: "abc123", battleResults }, null, 2)); // Updated log message
        }

        // Render the battle UI
        function renderBattle(container) {
            const challenger = products[1];
            const battleWrapper = createElement("div", { className: "battle-wrapper" });

            const winnerDiv = createProductCard(currentWinner, challenger.id, true);
            const challengerDiv = createProductCard(challenger, currentWinner.id, false);

            battleWrapper.appendChild(winnerDiv);
            battleWrapper.appendChild(challengerDiv);
            container.appendChild(battleWrapper);
        }

        // Create product card
        function createProductCard(product, opponentId, isCurrentWinner) {
            const productDiv = createElement("div");

            const title = createElement("h2", {}, product.name);
            const button = createElement("button", {}, "Vote");

            button.onclick = () => vote(product.id, opponentId, isCurrentWinner);

            productDiv.appendChild(title);
            productDiv.appendChild(button);

            return productDiv;
        }

        // Handle voting
        function vote(winnerId, loserId, isCurrentWinner) {
            // store battle result
            battleResults.push({
                round: currentRound,
                winner_id: winnerId,
                loser_id: loserId,
            });

            currentRound++;

            // update current winner
            if (!isCurrentWinner) {
                currentWinner = products[1]; // Challenger becomes new winner
            }

            // Remove the losing product
            products = products.filter(product => product.id !== loserId);

            // Render the next battle
            renderBattleIfNeeded();
        }

        // Create an HTML element with attributes and text content
        function createElement(tag, attributes = {}, textContent = "") {
            const element = document.createElement(tag);
            for (const [key, value] of Object.entries(attributes)) {
                element[key] = value;
            }
            if (textContent) {
                element.textContent = textContent;
            }
            return element;
        }

        fetchProducts();
    </script>
</body>
</html>